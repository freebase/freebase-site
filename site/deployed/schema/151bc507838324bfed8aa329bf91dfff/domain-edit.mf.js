(function(b){b.fn.showRow=function(j,f,a){f=f==="fadeIn"?"fadeIn":"slideDown";var e=this;return this.each(function(){var c=b(this).hide(),d=b("> td, > th",c).wrapInner('<div class="wrapInner" style="display: block;">');d=b(".wrapInner",d).hide();c.show();d[f](a,function(){b(this).each(function(){b(this).replaceWith(b(this).contents())});j&&j.call(e)})})};b.fn.hideRow=function(j,f,a){f=f==="fadeOut"?"fadeOut":"slideUp";var e=this;return this.each(function(){var c=b(this).show(),d=b("> td, > th",c).wrapInner('<div class="wrapInner" style="display: block;">');
b(".wrapInner",d)[f](a,function(){b(this).each(function(){b(this).replaceWith(b(this).contents())});c.hide();j&&j.call(e)})})}})(jQuery);
(function(b,j){var f=j.schema.domain.edit={add_new_type_begin:function(a,e,c){b.ajax({url:acre.request.app_url+"/schema/service/add_new_type_begin",data:{id:e,mediator:c?1:0},dataType:"json",success:function(d,g,i){if(d.code==="/api/status/error")return f.ajax_error_handler(i,row);d=b(d.result.html);var h={mode:"add",ajax:{url:acre.request.app_url+"/schema/service/add_new_type_submit"},table:a.parents("table:first"),trigger:a,trigger_row:a.parents("tr:first"),row:b(".edit-row",d).hide(),submit:b(".edit-row-submit",
d).hide()};f.init_edit_type(h);h.row.bind("fb.schema.domain.edit.type.success",function(){var k=b("thead:first .table-empty-column",h.table);k.length&&k.parents("tr:first").hide().prev("tr").show();b(".button-cancel",h.submit).text("Done");f.init_edit_type_form_row(h)})},error:function(d){f.ajax_error_handler(d,row)}})},edit_type_begin:function(a,e){b.ajax({url:acre.request.app_url+"/schema/service/edit_type_begin",data:{id:e},dataType:"json",success:function(c,d,g){if(c.code==="/api/status/error")return f.ajax_error_handler(g,
row);c=b(c.result.html);var i={mode:"edit",ajax:{url:acre.request.app_url+"/schema/service/edit_type_submit",data:{id:e}},table:a.parents("table:first"),trigger:a,trigger_row:a.parents("tr:first"),row:b(".edit-row",c).hide(),submit:b(".edit-row-submit",c).hide()};f.init_edit_type(i);i.row.bind("fb.schema.domain.edit.type.success",function(){i.trigger_row.remove();i.row.remove();i.submit.remove()})},error:function(c){f.ajax_error_handler(c,row)}})},init_edit_type:function(a){if(a.mode==="add")b("tbody",
a.table).append(a.row);else if(a.mode==="edit")a.trigger_row.before(a.row);else throw"Unknown edit type mode: "+a.mode;a.trigger_row.before(a.submit);a.row.showRow(function(){f.init_edit_type_form(a)});a.trigger_row.hide();a.submit.show();a.row.bind("fb.schema.domain.edit.type.submit",function(){console.log("fb.schema.domain.edit.type.submit");f.edit_type_submit(a)}).bind("fb.schema.domain.edit.type.cancel",function(){console.log("fb.schema.domain.edit.type.cancel");f.edit_type_cancel(a)}).bind("fb.schema.domain.edit.type.error",
function(e,c,d){console.log("fb.schema.domain.edit.type.error",c,d);f.edit_type_error(c,d)})},init_edit_type_form:function(a){var e=b(".button-submit",a.submit).click(function(){a.row.trigger("fb.schema.domain.edit.type.submit")});a.row.bind("change",function(){j.enable(e)});b(".button-cancel",a.submit).click(function(){a.row.trigger("fb.schema.domain.edit.type.cancel")});f.init_edit_type_form_row(a)},init_edit_type_form_row:function(a){var e=b(":input[name=name]",a.row),c=b(":input[name=key]",a.row).data("changed",
false),d=b(":input[name=description]",a.row);if(a.mode==="add"){e.val("");c.val("").data("changed",false);d.val("")}if(!a.row.data("initialized")){c.change(function(){b(this).data("changed",true)});e.change(function(){if(!c.data("changed")){var g=b.trim(e.val()).toLowerCase().replace(/\s+/g,"-");c.val(g)}});b(":input",a.row).keyup(function(g){if(g.keyCode===13)a.row.trigger("fb.schema.domain.edit.type.submit");else g.keyCode===27&&a.row.trigger("fb.schema.domain.edit.type.cancel")});a.row.data("initialized",
true)}e.focus()},edit_type_cancel:function(a){a.row.hideRow(function(){b(this).remove()});a.submit.remove();a.trigger_row.show();a.trigger.removeClass("editing")},edit_type_submit:function(a){if(!a.row.is(".loading"))if(!b(".button-submit",a.submit).is(":disabled")){document.activeElement&&b(document.activeElement).blur();a.row.prev(".row-msg").remove();f.edit_type_form_row_validate(a.row);if(!a.row.prev(".row-msg-error").length){a.row.addClass("loading");var e=b.trim(b(":input[name=name]",a.row).val()),
c=b.trim(b(":input[name=key]",a.row).val()),d=b(":input[name=typehint]",a.row);d=d.is(":checked")?d.val():"";e={domain:b(":input[name=domain]",a.row).val(),name:e,key:c,typehint:d,description:b(":input[name=description]",a.row).val()};b.ajax({url:a.ajax.url,type:"POST",dataType:"json",data:b.extend(e,a.ajax.data),success:function(g,i,h){if(g.code==="/api/status/error")return f.ajax_error_handler(h,a.row);var k=b(g.result.html).addClass("new-row");a.row.before(k);k.hide();k.showRow(function(){j.schema.init_row_menu(k);
b(".edit",k).show()},null,"slow");a.row.trigger("fb.schema.domain.edit.type.success")},error:function(g){f.ajax_error_handler(g,a.row)},complete:function(){a.row.removeClass("loading")}})}}},edit_type_form_row_validate:function(a){var e=b.trim(b(":input[name=name]",a).val()),c=b.trim(b(":input[name=key]",a).val());if(e===""||c==="")a.trigger("fb.schema.domain.edit.type.error",[a,"Name and Key is required"])},delete_type_begin:function(a,e){var c=a.parents("tr:first");c.parents("table:first");b.ajax({url:acre.request.app_url+
"/schema/service/delete_type_submit",data:{id:e,user:j.user.id},type:"POST",dataType:"json",success:function(d,g,i){if(d.code==="/api/status/error")return f.ajax_error_handler(i,c);d=b(d.result.html).addClass("new-row");c.before(d);d.hide();c.remove();d.showRow()},error:function(d){f.ajax_error_handler(d,c)}})},undo_delete_type_begin:function(a,e){var c=a.parents("tr:first");c.parents("table:first");b.ajax({url:acre.request.app_url+"/schema/service/undo_delete_type_submit",data:{type_info:JSON.stringify(e)},
type:"POST",dataType:"json",success:function(d,g,i){if(d.code==="/api/status/error")return f.ajax_error_handler(i,c);var h=b(d.result.html).addClass("new-row");c.before(h);h.hide();c.remove();h.showRow(function(){j.schema.init_row_menu(h);b(".edit",h).show()},null,"slow")},error:function(d){f.ajax_error_handler(d,c)}})},ajax_error_handler:function(a,e){var c;try{c=JSON.parse(a.responseText);c=c.messages[0].message}catch(d){c=a.responseText}f.edit_type_error(e,c)},edit_type_error:function(a,e){f.edit_type_row_message(a,
f.row_message(e,"error"))},edit_type_row_message:function(a,e){a.before(e);e.hide().showRow()},row_message:function(a,e){var c=b("<span>").text(a);c=b('<td colspan="5">').append(c);c=b('<tr class="row-msg">').append(c);e&&c.addClass("row-msg-"+e);return c}}})(jQuery,window.freebase);
